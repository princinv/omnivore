name: Build Self-Hosting Docker Images
on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'apple/**'
      - 'android/**'
      - 'self-hosting/**'

jobs:
  build-self-hostdocker-images:
    name: Build self-host docker images
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-latest
    env:
      NS: ghcr.io/${{ github.repository_owner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute TAG
        id: vars
        run: echo "TAG=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      # API
      - name: Build & push API
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/api/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.NS }}/omnivore-api:${{ steps.vars.outputs.TAG }}
            ${{ env.NS }}/omnivore-api:latest

      # Web (use the normal Dockerfile you fixed, not Dockerfile-self)
      - name: Build & push Web
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/web/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.NS }}/omnivore-web:${{ steps.vars.outputs.TAG }}
            ${{ env.NS }}/omnivore-web:latest

      # Content Fetch
      - name: Build & push Fetch
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/content-fetch/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.NS }}/omnivore-fetch:${{ steps.vars.outputs.TAG }}
            ${{ env.NS }}/omnivore-fetch:latest

      # Migrate (one-shot job image)
      - name: Build & push Migrate
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/db/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.NS }}/omnivore-migrate:${{ steps.vars.outputs.TAG }}
            ${{ env.NS }}/omnivore-migrate:latest
